// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCWnB4VDxuH60J06E0XMGiNzD2m1Rq7HWw",
  authDomain: "team-builder-42438.firebaseapp.com",
  projectId: "team-builder-42438",
  storageBucket: "team-builder-42438.firebasestorage.app",
  messagingSenderId: "215714435049",
  appId: "1:215714435049:web:8b136178e7f8379bf90578",
  measurementId: "G-RJ0ZB7FJ0D"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- NEW Application Code ---

// Wait for the HTML document to be fully loaded before running our code
document.addEventListener('DOMContentLoaded', () => {

    // Get references to our new HTML elements
    const fileInput = document.getElementById('csv-file-input');
    const importButton = document.getElementById('import-button');
    const exportButton = document.getElementById('export-button');
    const rosterList = document.getElementById('roster-list');
    const fileNameDisplay = document.getElementById('file-name-display');

    let chosenFile = null;

    // Listen for when a file is chosen
    fileInput.addEventListener('change', (event) => {
        chosenFile = event.target.files[0];
        if (chosenFile) {
            fileNameDisplay.textContent = chosenFile.name;
        } else {
            fileNameDisplay.textContent = 'No file chosen';
        }
    });

    // Listen for click on the Import button
    importButton.addEventListener('click', () => {
        if (!chosenFile) {
            alert('Please choose a CSV file first.');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(event) {
            const csvData = event.target.result;
            parseAndUpload(csvData);
        };
        reader.readAsText(chosenFile);
    });

    // Listen for click on the Export button
    exportButton.addEventListener('click', exportRosterToCSV);

    // --- Core Functions ---

    /**
     * Parses CSV data, finds the "Player" column, and uploads to Firebase
     */
    function parseAndUpload(csvData) {
        // Split into rows, trimming any extra whitespace
        const rows = csvData.split('\n').map(row => row.trim());
        if (rows.length < 2) {
            alert('CSV file is empty or has no data.');
            return;
        }

        // Get header row and clean it
        const header = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
        
        // Find the "Player" column
        const playerIndex = header.indexOf('Player');
        
        if (playerIndex === -1) {
            alert('Could not find a "Player" column in the CSV file.');
            return;
        }

        // Get a new "batch" operation from Firebase
        const batch = db.batch();
        let playersAdded = 0;

        // Loop through data rows (skip header row 0)
        for (let i = 1; i < rows.length; i++) {
            if (rows[i]) { // Skip empty rows
                const rowData = rows[i].split(',');
                const playerName = rowData[playerIndex];

                if (playerName) {
                    const cleanedName = playerName.trim().replace(/"/g, '');
                    
                    // Create a new document in the "roster" collection
                    // We use the player's name as the document ID for easy lookup
                    const playerRef = db.collection('roster').doc(cleanedName);
                    
                    // Add player to the batch
                    batch.set(playerRef, {
                        name: cleanedName,
                        availability: 'Unknown' // Default availability
                    });
                    playersAdded++;
                }
            }
        }

        // "Commit" the batch to run all "set" operations at once
        batch.commit()
            .then(() => {
                alert(`Successfully imported ${playersAdded} players!`);
                loadRoster(); // Reload the roster list from the database
                fileNameDisplay.textContent = 'No file chosen'; // Reset
                fileInput.value = ''; // Reset
                chosenFile = null;
            })
            .catch(error => {
                console.error('Error importing roster: ', error);
                alert('An error occurred while importing the roster.');
            });
    }

    /**
     * Fetches all documents from the "roster" collection and displays them
     */
    function loadRoster() {
        // Clear the current list
        rosterList.innerHTML = '<li>Loading...</li>';

        db.collection('roster').orderBy('name').get()
            .then(querySnapshot => {
                // Clear the "Loading..." message
                rosterList.innerHTML = ''; 
                
                if (querySnapshot.empty) {
                    rosterList.innerHTML = '<li>Roster is empty.</li>';
                    return;
                }

                querySnapshot.forEach(doc => {
                    const player = doc.data();
                    
                    // Create a new list item element
                    const li = document.createElement('li');
                    li.textContent = player.name;
                    // We can add more info here later, like availability
                    
                    rosterList.appendChild(li);
                });
            })
            .catch(error => {
                console.error('Error loading roster: ', error);
                rosterList.innerHTML = '<li>Error loading roster.</li>';
            });
    }

    /**
     * Fetches the current roster and downloads it as a CSV file
     */
    async function exportRosterToCSV() {
        try {
            const querySnapshot = await db.collection('roster').orderBy('name').get();
            
            if (querySnapshot.empty) {
                alert('Roster is empty, nothing to export.');
                return;
            }

            let csvContent = "Name,Availability\n"; // CSV Header

            querySnapshot.forEach(doc => {
                const player = doc.data();
                csvContent += `"${player.name}","${player.availability}"\n`;
            });

            // Create a "dummy" link to trigger the download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', 'roster_export.csv');
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click(); // Programmatically click the link
            document.body.removeChild(link); // Clean up

        } catch (error) {
            console.error('Error exporting roster: ', error);
            alert('An error occurred while exporting.');
        }
    }

    // --- Initial Page Load ---
    // Load the roster from Firebase as soon as the page is ready
    loadRoster(); 
});
